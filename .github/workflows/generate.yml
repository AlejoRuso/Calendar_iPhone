name: Generate Calendar Daily

on:
  schedule:
    - cron: '0 20 * * *'  # 21:00 UTC = 00:00 MSK
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'config.json'
      - 'generate_calendar.py'

permissions:
  contents: write

jobs:
  generate-calendar:
    runs-on: ubuntu-latest
    
    env:
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system fonts (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞ + Arial)
      run: |
        echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã –∏ Arial..."
        
        # –ü—Ä–∏–Ω–∏–º–∞–µ–º –ª–∏—Ü–µ–Ω–∑–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
        echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | sudo debconf-set-selections
        echo "ttf-mscorefonts-installer msttcorefonts/present-mscorefonts-eula note" | sudo debconf-set-selections
        
        sudo apt-get update
        sudo apt-get install -y \
          fonts-dejavu \
          fonts-liberation \
          fonts-liberation2 \
          fonts-noto \
          fonts-noto-cjk \
          fonts-noto-color-emoji \
          fonts-freefont-ttf \
          fonts-crosextra-caladea \
          fonts-crosextra-carlito \
          ttf-mscorefonts-installer \
          fontconfig
        
        # –Ø–≤–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à—Ä–∏—Ñ—Ç—ã Noto —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π
        sudo apt-get install -y fonts-noto-extra fonts-noto-cjk fonts-noto-core
        
        # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º –∫—ç—à —à—Ä–∏—Ñ—Ç–æ–≤
        sudo fc-cache -f -v
        echo "‚úÖ –®—Ä–∏—Ñ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —É—Å—Ç–∞–Ω–æ–≤–∫—É
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —à—Ä–∏—Ñ—Ç–æ–≤:"
        fc-match Arial
        fc-match "DejaVu Sans"
        fc-match "Noto Sans"
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —à—Ä–∏—Ñ—Ç—ã —Å –∫–∏—Ä–∏–ª–ª–∏—Ü–µ–π:"
        fc-list :lang=ru | head -20 || echo "–ù–µ –Ω–∞–π–¥–µ–Ω–æ —à—Ä–∏—Ñ—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã"
        echo ""
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —à—Ä–∏—Ñ—Ç—ã Arial:"
        fc-list | grep -i arial || echo "Arial –Ω–µ –Ω–∞–π–¥–µ–Ω"
        echo ""
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ —à—Ä–∏—Ñ—Ç–æ–≤:"
        ls -la /usr/share/fonts/truetype/msttcorefonts/ 2>/dev/null | head -10 || echo "–ü–∞–ø–∫–∞ msttcorefonts –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        ls -la /usr/share/fonts/truetype/dejavu/ 2>/dev/null | head -10 || echo "–ü–∞–ø–∫–∞ dejavu –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        ls -la /usr/share/fonts/truetype/liberation/ 2>/dev/null | head -10 || echo "–ü–∞–ø–∫–∞ liberation –Ω–µ –Ω–∞–π–¥–µ–Ω–∞"
        echo ""
        echo "üìä –í—Å–µ–≥–æ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã—Ö —à—Ä–∏—Ñ—Ç–æ–≤:"
        fc-list | wc -l
    
    - name: Install Python dependencies
      run: |
        pip install Pillow
        echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    - name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ config.json
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ config.json:"
        file config.json
        echo ""
        echo "–ü–µ—Ä–≤—ã–µ 200 –±–∞–π—Ç —Ñ–∞–π–ª–∞:"
        head -c 200 config.json | od -c
        echo ""
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –º–µ—Å—è—Ü–µ–≤:"
        python3 -c "
import json
try:
    with open('config.json', 'r', encoding='utf-8') as f:
        data = json.load(f)
    months = data.get('calendar', {}).get('months', [])
    for i, month in enumerate(months):
        print(f'{i+1:2d}. \"{month}\" (–¥–ª–∏–Ω–∞: {len(month)}, –±–∞–π—Ç—ã: {month.encode(\"utf-8\")})')
except Exception as e:
    print(f'–û—à–∏–±–∫–∞: {e}')
        "
    
    - name: Check environment
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
        python --version
        echo "–ö–æ–¥–∏—Ä–æ–≤–∫–∞:"
        python -c "import sys; print('–ü–æ —É–º–æ–ª—á–∞–Ω–∏—é:', sys.getdefaultencoding()); print('–§–∞–π–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞:', sys.getfilesystemencoding())"
        echo "–õ–æ–∫–∞–ª—å:"
        python -c "import locale; print(locale.getlocale())"
        echo "–î–æ—Å—Ç—É–ø–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã:"
        python3 -c "
from PIL import ImageFont, ImageDraw, Image
import os

test_paths = [
    '/usr/share/fonts/truetype/msttcorefonts/Arial.ttf',
    '/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf',
    '/usr/share/fonts/truetype/liberation/LiberationSans-Regular.ttf',
    '/usr/share/fonts/truetype/noto/NotoSans-Regular.ttf',
]

for path in test_paths:
    if os.path.exists(path):
        try:
            font = ImageFont.truetype(path, 20)
            print(f'‚úì {path}')
        except Exception as e:
            print(f'‚úó {path} (–æ—à–∏–±–∫–∞: {e})')
    else:
        print(f'‚úó {path} (–Ω–µ –Ω–∞–π–¥–µ–Ω)')
        "
    
    - name: Fix config encoding
      run: |
        echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ config.json..."
        if [ -f "config.json" ]; then
          # –£–±–∏—Ä–∞–µ–º BOM –µ—Å–ª–∏ –µ—Å—Ç—å
          sed -i '1s/^\xEF\xBB\xBF//' config.json 2>/dev/null || true
          echo "‚úÖ –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞"
        else
          echo "‚ö† config.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
    
    - name: Generate calendar image
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è..."
        python generate_calendar.py 2>&1 | tee generation.log
        echo "üìã –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ generation.log"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏
        if grep -q "‚ùå" generation.log; then
          echo "‚ö† –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏:"
          grep -A5 -B5 "‚ùå" generation.log
          exit 1
        fi
    
    - name: Verify generated image
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è..."
        if [ -f "calendar.png" ]; then
          echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ"
          echo "üìè –†–∞–∑–º–µ—Ä: $(wc -c < calendar.png) –±–∞–π—Ç"
          echo "üìê –†–∞–∑–º–µ—Ä—ã:"
          python3 -c "
from PIL import Image
try:
    img = Image.open('calendar.png')
    print(f'  –®–∏—Ä–∏–Ω–∞: {img.width}px')
    print(f'  –í—ã—Å–æ—Ç–∞: {img.height}px')
    print(f'  –§–æ—Ä–º–∞—Ç: {img.format}')
    print(f'  –†–µ–∂–∏–º: {img.mode}')
except Exception as e:
    print(f'  –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ: {e}')
          "
        else
          echo "‚ùå calendar.png –Ω–µ –Ω–∞–π–¥–µ–Ω"
          exit 1
        fi
    
    - name: Create HTML redirect
      run: |
        echo '<!DOCTYPE html>
        <html lang="ru">
        <head>
          <meta charset="UTF-8">
          <meta http-equiv="refresh" content="0; url=calendar.png">
          <link rel="icon" href="data:,">
          <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</title>
          <style>
            body { margin: 0; padding: 0; background: #000; }
            img { display: block; margin: 0 auto; max-width: 100%; height: auto; }
          </style>
        </head>
        <body>
          <img src="calendar.png" alt="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≥–æ–¥–∞">
        </body>
        </html>' > index.html
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add calendar.png index.html generation.log 2>/dev/null || true
        
        if git diff --cached --quiet; then
          echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          MSK_TIME=$(TZ='Europe/Moscow' date +'%Y-%m-%d %H:%M')
          git commit -m "Auto-update: $MSK_TIME MSK [skip ci]"
          git push
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø—É—à–µ–Ω—ã"
        fi
    
    - name: Completion notice
      run: |
        echo "üéâ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
        echo "üåê –°—Å—ã–ª–∫–∞: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/calendar.png"
        echo ""
        echo "üìä –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:"
        echo "  - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/calendar.png"
        echo "  - –õ–æ–≥–∏: https://github.com/${{ github.repository }}/blob/main/generation.log"