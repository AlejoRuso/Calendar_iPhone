name: Generate Calendar Daily

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'config.json'
      - 'generate_calendar.py'

permissions:
  contents: write

jobs:
  generate-calendar:
    runs-on: ubuntu-latest
    
    env:
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system fonts
      run: |
        echo "Installing fonts..."
        echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | sudo debconf-set-selections
        sudo apt-get update
        sudo apt-get install -y fonts-dejavu fonts-liberation fonts-noto ttf-mscorefonts-installer
        sudo fc-cache -f -v
    
    - name: Install Python dependencies
      run: |
        pip install Pillow
    
    - name: Fix config encoding
      run: |
        if [ -f "config.json" ]; then
          sed -i '1s/^\xEF\xBB\xBF//' config.json 2>/dev/null || true
        fi
    
    - name: Generate calendar image
      run: |
        python generate_calendar.py 2>&1 | tee generation.log
        if grep -q "‚ùå" generation.log; then
          echo "Errors found"
          exit 1
        fi
    
    - name: Verify generated image
      run: |
        if [ -f "calendar.png" ]; then
          echo "Image created: $(wc -c < calendar.png) bytes"
        else
          echo "calendar.png not found"
          exit 1
        fi
    
    - name: Prepare GitHub Pages files
      run: |
        # –°–æ–∑–¥–∞–µ–º .nojekyll —Ñ–∞–π–ª –¥–ª—è –æ—Ç–∫–ª—é—á–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ Jekyll
        echo "" > .nojekyll
        
        # –°–æ–∑–¥–∞–µ–º index.html —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
        cat > index.html << 'HTML'
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≥–æ–¥–∞</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            font-family: Arial, sans-serif;
        }
        .container {
            text-align: center;
        }
        img {
            max-width: 100%;
            height: auto;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        .footer {
            color: #666;
            margin-top: 20px;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <div class="container">
        <img src="calendar.png" alt="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≥–æ–¥–∞" id="calendar-image">
        <div class="footer">–û–±–Ω–æ–≤–ª–µ–Ω–æ: <span id="update-time"></span></div>
    </div>
    <script>
        // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        document.getElementById('update-time').textContent = new Date().toLocaleString('ru-RU');
        
        // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
        setInterval(() => {
            const img = document.getElementById('calendar-image');
            img.src = img.src.split('?')[0] + '?t=' + new Date().getTime();
        }, 300000);
    </script>
</body>
</html>
HTML
        echo "‚úÖ –§–∞–π–ª—ã –¥–ª—è GitHub Pages —Å–æ–∑–¥–∞–Ω—ã"
    
    - name: List generated files
      run: |
        echo "üìÇ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
        ls -la *.png *.html .nojekyll 2>/dev/null || echo "–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./
        publish_branch: main
        force_orphan: false
        enable_jekyll: false
        cname: ""
        commit_message: "Auto-update: $(date -u +'%Y-%m-%d %H:%M') UTC"
    
    - name: Verify deployment
      run: |
        echo "üéâ –î–µ–ø–ª–æ–π –∑–∞–≤–µ—Ä—à–µ–Ω!"
        echo "üåê –í–∞—à —Å–∞–π—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É:"
        echo "   https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo ""
        echo "üìä –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:"
        echo "  1. –û—Ç–∫—Ä–æ–π—Ç–µ https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        echo "  2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤:"
        echo "     - calendar.png"
        echo "     - index.html"
        echo "     - .nojekyll"
        echo ""
        echo "‚ö†Ô∏è  –ï—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—Å–µ –µ—â–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç 404:"
        echo "  1. –ü–æ–¥–æ–∂–¥–∏—Ç–µ 1-2 –º–∏–Ω—É—Ç—ã"
        echo "  2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ GitHub Pages: Settings ‚Üí Pages"
        echo "  3. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã–±—Ä–∞–Ω branch: main –∏ folder: / (root)"