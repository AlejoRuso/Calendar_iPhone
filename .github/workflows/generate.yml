name: Generate Calendar Daily

on:
  schedule:
    - cron: '0 20 * * *'  # 21:00 UTC = 00:00 MSK
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'config.json'
      - 'generate_calendar.py'

permissions:
  contents: write

jobs:
  generate-calendar:
    runs-on: ubuntu-latest
    
    env:
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system fonts (–∫–∏—Ä–∏–ª–ª–∏—Ü–∞)
      run: |
        echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —à—Ä–∏—Ñ—Ç–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∫–∏—Ä–∏–ª–ª–∏—Ü—ã..."
        sudo apt-get update
        sudo apt-get install -y \
          fonts-dejavu-core \
          fonts-dejavu-extra \
          fonts-liberation \
          fonts-noto-core \
          fonts-noto-extra \
          fonts-freefont-ttf
        fc-cache -f -v
        echo "‚úÖ –®—Ä–∏—Ñ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    - name: Install Python dependencies
      run: |
        pip install Pillow
        echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    - name: Check environment
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
        python --version
        echo "–ö–æ–¥–∏—Ä–æ–≤–∫–∞:"
        python -c "import sys; print(sys.getdefaultencoding())"
        echo "–®—Ä–∏—Ñ—Ç—ã:"
        fc-list | grep -i "dejavu\|liberation\|noto" | head -10
    
    - name: Fix config encoding
      run: |
        echo "üîß –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∏—Ä–æ–≤–∫–∏ config.json..."
        if [ -f "config.json" ]; then
          # –£–±–∏—Ä–∞–µ–º BOM –µ—Å–ª–∏ –µ—Å—Ç—å
          sed -i '1s/^\xEF\xBB\xBF//' config.json 2>/dev/null || true
          echo "‚úÖ –ö–æ–¥–∏—Ä–æ–≤–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞"
        else
          echo "‚ö† config.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
    
    - name: Generate calendar image
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è..."
        python generate_calendar.py 2>&1 | tee generation.log
        echo "üìã –õ–æ–≥–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ generation.log"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –æ—à–∏–±–∫–∏
        if grep -q "‚ùå" generation.log; then
          echo "‚ö† –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏:"
          grep -A5 -B5 "‚ùå" generation.log
          exit 1
        fi
    
    - name: Verify generated image
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è..."
        if [ -f "calendar.png" ]; then
          echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ"
          echo "üìè –†–∞–∑–º–µ—Ä: $(wc -c < calendar.png) –±–∞–π—Ç"
        else
          echo "‚ùå calendar.png –Ω–µ –Ω–∞–π–¥–µ–Ω"
          exit 1
        fi
    
    - name: Create HTML redirect
      run: |
        echo '<!DOCTYPE html>
        <html lang="ru">
        <head>
          <meta charset="UTF-8">
          <meta http-equiv="refresh" content="0; url=calendar.png">
          <link rel="icon" href="data:,">
          <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</title>
          <style>
            body { margin: 0; padding: 0; background: #000; }
            img { display: block; margin: 0 auto; max-width: 100%; height: auto; }
          </style>
        </head>
        <body>
          <img src="calendar.png" alt="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≥–æ–¥–∞">
        </body>
        </html>' > index.html
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add calendar.png index.html generation.log 2>/dev/null || true
        
        if git diff --cached --quiet; then
          echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          MSK_TIME=$(TZ='Europe/Moscow' date +'%Y-%m-%d %H:%M')
          git commit -m "Auto-update: $MSK_TIME MSK [skip ci]"
          git push
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø—É—à–µ–Ω—ã"
        fi
    
    - name: Completion notice
      run: |
        echo "üéâ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
        echo "üåê –°—Å—ã–ª–∫–∞: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/calendar.png"