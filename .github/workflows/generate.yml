name: Generate Calendar Daily

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'config.json'
      - 'generate_calendar.py'

permissions:
  contents: write

jobs:
  generate-calendar:
    runs-on: ubuntu-latest
    
    env:
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system fonts
      run: |
        echo "Installing fonts..."
        echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | sudo debconf-set-selections
        sudo apt-get update
        sudo apt-get install -y fonts-dejavu fonts-liberation fonts-noto ttf-mscorefonts-installer
        sudo fc-cache -f -v
    
    - name: Install Python dependencies
      run: |
        pip install Pillow
    
    - name: Fix config encoding
      run: |
        if [ -f "config.json" ]; then
          sed -i '1s/^\xEF\xBB\xBF//' config.json 2>/dev/null || true
        fi
    
    - name: Generate calendar image
      run: |
        python generate_calendar.py 2>&1 | tee generation.log
        if grep -q "❌" generation.log; then
          echo "Errors found"
          exit 1
        fi
    
    - name: Verify generated image
      run: |
        if [ -f "calendar.png" ]; then
          echo "Image created: $(wc -c < calendar.png) bytes"
        else
          echo "calendar.png not found"
          exit 1
        fi
    
    - name: Create HTML redirect
      run: |
        echo '<!DOCTYPE html><html><head><meta charset="UTF-8"><meta http-equiv="refresh" content="0; url=calendar.png"><title>Calendar</title></head><body><img src="calendar.png"></body></html>' > index.html
    
    - name: Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git checkout -b gh-pages 2>/dev/null || git checkout gh-pages
        git add calendar.png index.html generation.log 2>/dev/null || true
        
        if git diff --cached --quiet; then
          echo "ℹ️ Нет изменений для коммита"
        else
          MSK_TIME=$(TZ='Europe/Moscow' date +'%Y-%m-%d %H:%M')
          git commit -m "Auto-update: $MSK_TIME MSK [skip ci]"
          git push origin gh-pages
          echo "✅ Изменения запушены в ветку gh-pages"
        fi