name: Generate Calendar Daily

on:
  schedule:
    - cron: '0 20 * * *'
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        echo "ttf-mscorefonts-installer msttcorefonts/accepted-mscorefonts-eula select true" | sudo debconf-set-selections
        sudo apt-get install -y fonts-dejavu fonts-liberation fonts-noto ttf-mscorefonts-installer
        pip install Pillow
    
    - name: Debug - List files before generation
      run: |
        echo "üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –¥–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:"
        ls -la
        echo "üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º config.json:"
        if [ -f "config.json" ]; then
          echo "‚úÖ config.json —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
          head -20 config.json
        else
          echo "‚ùå config.json –Ω–µ –Ω–∞–π–¥–µ–Ω"
        fi
    
    - name: Generate calendar
      run: |
        echo "üîÑ –ó–∞–ø—É—Å–∫ generate_calendar.py..."
        python generate_calendar.py 2>&1
        
        echo "üìÇ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø–æ—Å–ª–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:"
        ls -la
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ calendar.png
        if [ -f "calendar.png" ]; then
          echo "‚úÖ calendar.png —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ"
          echo "üìè –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(wc -c < calendar.png) –±–∞–π—Ç"
        else
          echo "‚ùå calendar.png –Ω–µ –Ω–∞–π–¥–µ–Ω!"
          echo "üîç –ò—â–µ–º –¥—Ä—É–≥–∏–µ —Ñ–∞–π–ª—ã:"
          find . -name "*.png" -o -name "*.jpg" -o -name "*.jpeg" 2>/dev/null || echo "–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ"
          exit 1
        fi
    
    - name: Create website files
      run: |
        echo "üìÑ –°–æ–∑–¥–∞–µ–º —Ñ–∞–π–ª—ã –¥–ª—è —Å–∞–π—Ç–∞..."
        
        # –°–æ–∑–¥–∞–µ–º .nojekyll
        touch .nojekyll
        
        # –°–æ–∑–¥–∞–µ–º index.html
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <title>Calendar Progress</title>
            <style>
                body { margin: 0; padding: 0; background: #000; }
                img { display: block; margin: 0 auto; max-width: 100%; }
            </style>
        </head>
        <body>
            <img src="calendar.png" alt="Calendar Progress">
        </body>
        </html>
        EOF
        
        echo "‚úÖ –§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã:"
        ls -la *.html .nojekyll 2>/dev/null || echo "–§–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"
    
    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: main
        folder: ./
        clean: true
        clean-exclude: |
          .github/
          config.json
          generate_calendar.py
          *.py