name: Generate Calendar Daily

on:
  schedule:
    - cron: '0 20 * * *'  # –ó–∞–ø—É—Å–∫ –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 20:00 UTC
  workflow_dispatch:       # –†—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  generate:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          fonts-dejavu \
          fonts-liberation \
          fonts-noto \
          fonts-noto-cjk \
          fonts-noto-color-emoji
      
    - name: Install Python dependencies
      run: |
        pip install Pillow==10.0.0
    
    - name: Create generate_calendar.py
      run: |
        cat > generate_calendar.py << 'EOF'
        from PIL import Image, ImageDraw, ImageFont
        import datetime
        import json
        import os

        # –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏
        with open('config.json', 'r', encoding='utf-8') as f:
            config = json.load(f)

        # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        width, height = 800, 600
        image = Image.new('RGB', (width, height), color='white')
        draw = ImageDraw.Draw(image)

        # –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —à—Ä–∏—Ñ—Ç–æ–≤
        font_paths = [
            '/usr/share/fonts/truetype/dejavu/DejaVuSans-Bold.ttf',
            '/usr/share/fonts/truetype/liberation/LiberationSans-Bold.ttf',
            '/usr/share/fonts/truetype/noto/NotoSans-Bold.ttf',
        ]
        
        font = None
        for path in font_paths:
            if os.path.exists(path):
                try:
                    font = ImageFont.truetype(path, 36)
                    break
                except:
                    continue
        
        if font is None:
            font = ImageFont.load_default()

        # –¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞
        today = datetime.datetime.now()
        current_month = today.month
        current_day = today.day

        # –ó–∞–≥–æ–ª–æ–≤–æ–∫
        month_names = [
            '–Ø–Ω–≤–∞—Ä—å', '–§–µ–≤—Ä–∞–ª—å', '–ú–∞—Ä—Ç', '–ê–ø—Ä–µ–ª—å', '–ú–∞–π', '–ò—é–Ω—å',
            '–ò—é–ª—å', '–ê–≤–≥—É—Å—Ç', '–°–µ–Ω—Ç—è–±—Ä—å', '–û–∫—Ç—è–±—Ä—å', '–ù–æ—è–±—Ä—å', '–î–µ–∫–∞–±—Ä—å'
        ]
        title = f"{month_names[current_month-1]} {today.year}"
        title_bbox = draw.textbbox((0, 0), title, font=font)
        title_x = (width - (title_bbox[2] - title_bbox[0])) // 2
        draw.text((title_x, 50), title, fill='black', font=font)

        # –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–Ω–µ–π –º–µ—Å—è—Ü–∞
        days_in_month = (datetime.date(today.year, current_month % 12 + 1, 1) - 
                        datetime.timedelta(days=1)).day
        
        cell_size = 40
        start_x = (width - (7 * cell_size)) // 2
        start_y = 150
        
        # –î–Ω–∏ –Ω–µ–¥–µ–ª–∏
        weekdays = ['–ü–Ω', '–í—Ç', '–°—Ä', '–ß—Ç', '–ü—Ç', '–°–±', '–í—Å']
        for i, day in enumerate(weekdays):
            x = start_x + i * cell_size + cell_size // 2
            draw.text((x, start_y - 30), day, fill='gray', font=font, anchor='mm')

        # –ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –∫–∞–ª–µ–Ω–¥–∞—Ä—è
        first_day = datetime.date(today.year, current_month, 1)
        start_offset = first_day.weekday()  # 0=–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫, 6=–í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
        
        for day in range(1, days_in_month + 1):
            row = (start_offset + day - 1) // 7
            col = (start_offset + day - 1) % 7
            
            x = start_x + col * cell_size + cell_size // 2
            y = start_y + row * cell_size + cell_size // 2
            
            color = 'blue' if day == current_day else 'black'
            draw.text((x, y), str(day), fill=color, font=font, anchor='mm')
            
            # –û–±–≤–æ–¥–∫–∞ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ –¥–Ω—è
            if day == current_day:
                rect_x1 = x - cell_size // 2 + 5
                rect_y1 = y - cell_size // 2 + 5
                rect_x2 = x + cell_size // 2 - 5
                rect_y2 = y + cell_size // 2 - 5
                draw.rectangle([rect_x1, rect_y1, rect_x2, rect_y2], outline='blue', width=2)

        # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ
        image.save('calendar.png', 'PNG')
        print(f"‚úÖ –ö–∞–ª–µ–Ω–¥–∞—Ä—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω –∫–∞–∫ calendar.png")
        EOF
    
    - name: Create config.json
      run: |
        cat > config.json << 'EOF'
        {
          "title": "–ú–æ–π –∫–∞–ª–µ–Ω–¥–∞—Ä—å",
          "language": "ru",
          "show_weekends": true,
          "weekend_color": "red"
        }
        EOF
    
    - name: Generate calendar
      run: |
        python generate_calendar.py
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç
        if [ -f "calendar.png" ]; then
          echo "‚úÖ calendar.png —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
          ls -lh calendar.png
        else
          echo "‚ùå calendar.png –Ω–µ —Å–æ–∑–¥–∞–Ω"
          exit 1
        fi
    
    - name: Create website
      run: |
        cat > index.html << 'EOF'
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Calendar Progress</title>
            <style>
                body {
                    margin: 0;
                    padding: 20px;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    min-height: 100vh;
                    display: flex;
                    flex-direction: column;
                    align-items: center;
                    justify-content: center;
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                }
                .container {
                    background: white;
                    padding: 30px;
                    border-radius: 20px;
                    box-shadow: 0 20px 60px rgba(0,0,0,0.3);
                    text-align: center;
                    max-width: 900px;
                }
                h1 {
                    color: #333;
                    margin-bottom: 20px;
                }
                .calendar-image {
                    border-radius: 10px;
                    border: 5px solid #4a5568;
                    max-width: 100%;
                    height: auto;
                }
                .timestamp {
                    margin-top: 20px;
                    color: #666;
                    font-size: 14px;
                }
                .info {
                    background: #f7fafc;
                    padding: 15px;
                    border-radius: 10px;
                    margin-top: 20px;
                    font-size: 14px;
                    color: #4a5568;
                }
            </style>
        </head>
        <body>
            <div class="container">
                <h1>üìÖ Calendar Progress</h1>
                <div class="info">
                    –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –µ–∂–µ–¥–Ω–µ–≤–Ω–æ –≤ 20:00 UTC
                </div>
                <img src="calendar.png" alt="Current Calendar" class="calendar-image">
                <div class="timestamp">
                    –ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ: <span id="current-time"></span>
                </div>
            </div>
            
            <script>
                document.getElementById('current-time').textContent = 
                    new Date().toLocaleString('ru-RU', {
                        timeZone: 'UTC',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                        timeZoneName: 'short'
                    });
            </script>
        </body>
        </html>
        EOF
        
        # –°–æ–∑–¥–∞–µ–º .nojekyll –¥–ª—è GitHub Pages
        touch .nojekyll
    
    - name: Deploy to GitHub Pages
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        branch: main
        folder: ./
        clean: true
        clean-exclude: |
          .github/
          config.json
          generate_calendar.py
          *.py