name: Generate Calendar Daily

on:
  schedule:
    - cron: '0 20 * * *'  # 21:00 UTC = 23:00 MSK
  workflow_dispatch:
  push:
    branches: [ main ]
    paths:
      - 'config.json'
      - 'generate_calendar.py'

permissions:
  contents: write

jobs:
  generate-calendar:
    runs-on: ubuntu-latest
    
    # –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã —Å UTF-8
    env:
      LC_ALL: C.UTF-8
      LANG: C.UTF-8
      PYTHONIOENCODING: utf-8
      PYTHONUTF8: 1
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        # –ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–±–Ω–æ–≤–ª—è–µ–º —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
        fetch-depth: 0
    
    - name: Setup Python with UTF-8
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'
    
    - name: Install system dependencies (fonts)
      run: |
        # –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —à—Ä–∏—Ñ—Ç—ã –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∫–∏—Ä–∏–ª–ª–∏—Ü—ã
        sudo apt-get update
        sudo apt-get install -y fonts-liberation fonts-dejavu-core ttf-mscorefonts-installer
        echo "‚úÖ –°–∏—Å—Ç–µ–º–Ω—ã–µ —à—Ä–∏—Ñ—Ç—ã —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    - name: Install Python dependencies
      run: |
        pip install Pillow
        echo "‚úÖ –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ Python —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
    
    - name: Check environment
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:"
        echo "Python –≤–µ—Ä—Å–∏—è: $(python --version)"
        echo "–ö–æ–¥–∏—Ä–æ–≤–∫–∞ Python: $(python -c 'import sys; print(sys.getdefaultencoding())')"
        echo "–õ–æ–∫–∞–ª—å: $(locale)"
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
        ls -la
        echo "–ü—Ä–æ–≤–µ—Ä–∫–∞ config.json:"
        if [ -f "config.json" ]; then
          echo "‚úÖ config.json –Ω–∞–π–¥–µ–Ω"
          echo "–ü–µ—Ä–≤—ã–µ 200 —Å–∏–º–≤–æ–ª–æ–≤ config.json:"
          head -c 200 config.json
          echo ""
          echo "–ö–æ–¥–∏—Ä–æ–≤–∫–∞ —Ñ–∞–π–ª–∞:"
          file -i config.json
        else
          echo "‚ùå config.json –Ω–µ –Ω–∞–π–¥–µ–Ω!"
        fi
    
    - name: Generate calendar image
      run: |
        echo "üöÄ –ó–∞–ø—É—Å–∫ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –∫–∞–ª–µ–Ω–¥–∞—Ä—è..."
        python generate_calendar.py 2>&1 | tee generation.log
        echo "üìã –õ–æ–≥–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –≤ generation.log"
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫
        if grep -q "‚ùå" generation.log; then
          echo "‚ö† –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã –æ—à–∏–±–∫–∏ –≤ –ª–æ–≥–∞—Ö"
          cat generation.log | grep -A5 -B5 "‚ùå"
          exit 1
        fi
        
        echo "‚úÖ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞"
    
    - name: Verify generated image
      run: |
        echo "üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è..."
        if [ -f "calendar.png" ]; then
          echo "‚úÖ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–æ —É—Å–ø–µ—à–Ω–æ"
          echo "üìè –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: $(wc -c < calendar.png) –±–∞–π—Ç"
          echo "üìê –†–∞–∑—Ä–µ—à–µ–Ω–∏–µ: $(identify -format '%wx%h' calendar.png 2>/dev/null || echo '–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å')"
        else
          echo "‚ùå –û—à–∏–±–∫–∞: calendar.png –Ω–µ –Ω–∞–π–¥–µ–Ω"
          echo "üìÑ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏:"
          ls -la
          exit 1
        fi
    
    - name: Create HTML redirect
      run: |
        echo "üåê –°–æ–∑–¥–∞–Ω–∏–µ HTML —Å—Ç—Ä–∞–Ω–∏—Ü—ã..."
        echo '<!DOCTYPE html>
        <html lang="ru">
        <head>
          <meta charset="UTF-8">
          <meta http-equiv="refresh" content="0; url=calendar.png">
          <link rel="icon" href="data:,">
          <meta name="generated" content="$(date -u +"%Y-%m-%dT%H:%M:%SZ")">
          <meta name="timezone" content="Europe/Moscow">
          <title>–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞</title>
          <style>
            body { margin: 0; padding: 0; background: #000; }
            img { display: block; margin: 0 auto; max-width: 100%; height: auto; }
          </style>
        </head>
        <body>
          <img src="calendar.png" alt="–ö–∞–ª–µ–Ω–¥–∞—Ä—å –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≥–æ–¥–∞">
        </body>
        </html>' > index.html
        
        echo "‚úÖ HTML —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞"
    
    - name: Commit and push changes
      run: |
        echo "üì§ –ö–æ–º–º–∏—Ç –∏ –ø—É—à –∏–∑–º–µ–Ω–µ–Ω–∏–π..."
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∞–π–ª—ã
        git add calendar.png index.html generation.log 2>/dev/null || true
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è
        if git diff --cached --quiet; then
          echo "‚ÑπÔ∏è –ù–µ—Ç –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫–æ–º–º–∏—Ç–∞"
        else
          # –ö–æ–º–º–∏—Ç —Å –≤—Ä–µ–º–µ–Ω–µ–º –ø–æ –ú–æ—Å–∫–≤–µ
          MSK_TIME=$(TZ='Europe/Moscow' date +'%Y-%m-%d %H:%M')
          git commit -m "Auto-update: $MSK_TIME MSK [skip ci]"
          
          # –ü—É—à –∏–∑–º–µ–Ω–µ–Ω–∏–π
          git push
          echo "‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏—è –∑–∞–ø—É—à–µ–Ω—ã –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π"
        fi
    
    - name: Upload logs as artifact (on failure)
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: generation-logs
        path: |
          generation.log
          config.json
        retention-days: 7
    
    - name: Completion notice
      run: |
        echo "üéâ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∫–∞–ª–µ–Ω–¥–∞—Ä—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!"
        echo "üåê –°—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/calendar.png"
        echo "‚è∞ –í—Ä–µ–º—è –∑–∞–ø—É—Å–∫–∞ (UTC): $(date -u +'%H:%M')"
        echo "üèôÔ∏è –í—Ä–µ–º—è –≤ –ú–æ—Å–∫–≤–µ: $(TZ='Europe/Moscow' date +'%H:%M')"
        echo "üîÑ –°–ª–µ–¥—É—é—â–∏–π –∑–∞–ø—É—Å–∫: –∑–∞–≤—Ç—Ä–∞ –≤ 21:00 UTC (00:00 MSK)"